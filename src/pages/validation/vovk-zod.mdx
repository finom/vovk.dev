# vovk-zod

<Tabs items={['npm', 'pnpm', 'yarn']}>
  <Tabs.Tab>
  ```
  npm i vovk-zod zod
  ```
</Tabs.Tab>
  <Tabs.Tab>
  ```
  pnpm i vovk-zod zod
  ```
  </Tabs.Tab>
  <Tabs.Tab>
  ```
  yarn add vovk-zod zod
  ```
  </Tabs.Tab>
</Tabs>

See live examples: [basic example](https://vovk-examples.vercel.app/zod) and [react-hook-form example](https://vovk-examples.vercel.app/zod-hook-form).


[vovk-zod](https://github.com/finom/vovk-zod) is the library that implements [Zod](https://zod.dev/) validation. It performs validation on the Controller side with `ZodModel.parse`, [converts the Zod object to a JSON Schema](https://www.npmjs.com/package/zod-to-json-schema) that's stored at [schema](/schema) files, and runs validation on client before the HTTP request is made with [Ajv](https://ajv.js.org/). `withZod` accepts body model, an optional query model and the handler function.

```ts filename="/src/modules/user/UserController.ts"
import { z } from 'zod';
import { put } from 'vovk';
import { withZod } from 'vovk-zod';
import UserService from './UserService';

const UpdateUserModel = z.object({ name: z.string(), email: z.email() }).strict();
const UpdateUserQueryModel = z.object({ id: z.uuid() }).strict();

export default class UserController {
    @put.auto()
    static updateUser = withZod(UpdateUserModel, UpdateUserQueryModel, async (req) => {
        const { name, email } = await req.json();
        const id = req.nextUrl.searchParams.get('id');

        return UserService.updateUser(id, { name, email });
    });
}
```

The request body and query receive the type inferred from the Zod objects.

`withZod` is implemented with multiple overloads where query model is optional and both body and query models can be set to null.

- `withZod(bodyModel: ZodObject | null, queryModel: ZodObject | null, handler: RequestHandler)`
- `withZod(bodyModel: ZodObject | null, handler: RequestHandler)`

Here is body only validation where `withZod` accepts 2 arguments: the body model and the handler.

```ts filename="/src/modules/user/UserService.ts"
// ...
export default class UserService {
    static async updateUser = withZod(UpdateUserModel, async (id, { name, email }) => {
        // ...
    });
}
```

To validate query only `withZod` accepts 3 arguments: `null`, the query model and the handler.

```ts filename="/src/modules/user/UserController.ts"
// ...
export default class UserController {
    @put.auto()
    static updateUser = withZod(null, UpdateUserQueryModel, async (req) => {
        // ...
    });
}
```

## Client validation

**vovk-zod** provides `validateOnClient` function exported from **vovk-zod/validateOnClient** that can be used to validate the request on the client-side at the resulting RPC function.

```ts
import { UserRPC } from 'vovk-client';
import validateOnClient from 'vovk-zod/validateOnClient';

UserRPC.updateUser({
    body: { name: 'John', email: 'john@example.com' },
    validateOnClient,
});
```

You can also define `validateOnClient` option at [/config](/config) file to apply it to all RPC functions globally so you don't need to pass it every time.

```ts filename="vovk.config.mjs"
export default {
    // ...
    validateOnClient: 'vovk-zod/validateOnClient',
};
```

## Form data

In order to use `FormData` with `withZod` to validate the request query, you need to fake type casting of body to `z.ZodType<FormData>`. At this case the library isn't going to validate the request body but still will validate the query.

```ts filename="/src/modules/user/UserController.ts"
export default class UserController {
    @put.auto()
    static updateUser = withZod(
        null as unknown as z.ZodType<FormData>, // fake type casting
        z.object({ id: z.uuid() }).strict(), // query model
        async (req) => {
            // get the FormData instance
            const formData = await req.formData();
            
            // or serialize the FormData to an object
            const formData = req.vovk.form<{ email: string; file: File }>();
        }
    );
}
```
See [VovkRequest](/controller/request) for more information.

At this case the RPC function is going to expect `body` to be an instance of `FormData`.

```ts
import { UserRPC } from 'vovk-client';

const body = new FormData();
body.append('email', 'john@example.com');
body.append('file', new File(['Hello, World!'], 'file.txt'));

UserRPC.updateUser({
    body,
    query: { id: '123' },
});
```
