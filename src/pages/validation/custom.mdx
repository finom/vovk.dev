# Custom Validation

You can create a decorator that, first of all, validates request on the server-side and optionally populates controller metadata with validation information that is going to be used by the client.

The simplest example of the validation would be equality validation. It does nothing than checking if received query and body are equal to some definite object but has no practical use outside of this documentation.

At the example below `validateEquality` decorator is created with `createDecorator` that accepts 2 arguments: server validation function and init function that populates `clientValidators` object to define how validation information should be stored at **.vovk.json** file.

```ts filename="/src/decorators/validateEquality.ts"
import { isEqual } from 'lodash';
import { 
  HttpException, HttpStatus, createDecorator, type VovkRequest, type VovkClientOptions 
} from 'vovk';

type BodyValidate = Record<string, unknown> | null;
type QueryValidate = Record<string, string> | null;

const validateEquality = createDecorator(
  async (req: VovkRequest<unknown>, next, bodyValidate?: BodyValidate, queryValidate?: QueryValidate) => {
    if (bodyValidate) {
      const body = await req.json();

      // override req.json to make it to be called again by controller code
      req.json = () => Promise.resolve(body);

      if (!isEqual(body, bodyValidate)) {
        throw new HttpException(HttpStatus.BAD_REQUEST, 'Server exception. Invalid body');
      }
    }

    if (queryValidate) {
      const query = Object.fromEntries(req.nextUrl.searchParams.entries());

      if (!isEqual(query, queryValidate)) {
        throw new HttpException(HttpStatus.BAD_REQUEST, 'Server exception. Invalid query');
      }
    }

    return next();
  },
  (bodyValidate?: BodyValidate, queryValidate?: QueryValidate) => ({
    clientValidators: {
      body: bodyValidate,
      query: queryValidate,
    },
  })
);

export default validateEquality;
```

Then create a file that defines client-side validation function as default export. 

```ts filename="/src/decorators/validateEqualityOnClient.ts"
import { type VovkClientOptions, HttpException, HttpStatus } from 'vovk';
import { isEqual } from 'lodash';

const validateEqualityOnClient: VovkClientOptions['validateOnClient'] = (input, validators) => {
  if (validators.body) {
    if (!isEqual(input.body, validators.body)) {
      throw new HttpException(HttpStatus.NULL, `Client exception. Invalid body`);
    }
  }

  if (validators.query) {
    if (!isEqual(input.query, validators.query)) {
      throw new HttpException(HttpStatus.NULL, `Client exception. Invalid query`);
    }
  }
};

export default validateEqualityOnClient;
```

At this example `validateEquality` is used as a controller decorator and `validateEqualityOnClient` is used internally by the client. Also notice that `validateEqualityOnClient` throws `HttpException` with status `0` to simulate regular HTTP exceptions that can be caught by the client-side code.

Here is how the newly created decorator is used at the controller.

```ts filename="/src/modules/hello/HelloController.ts"
import type { VovkRequest } from 'vovk';
import validateEquality from '../decorators/validateEquality';

export default class HelloController {
    @post.auto()
    @validateEquality({ foo: 42 }, { bar: 'hello' })
    static validatedRequest(req: VovkRequest<{ foo: 42 }, { bar: 'hello' }>) {
        // ...
    }
}
```

In order to enable client-side validation you need to define `validateOnClient` option in **vovk.config.js** file. For more info see [customization documentation](/customization).

```js filename="/vovk.config.js"
/** @type {import('vovk').VovkConfig} */
const vovkConfig = {
    validateOnClient: './src/decorators/validateEqualityOnClient',
}

module.exports = vovkConfig;
```

If your validation library is published on NPM it needs to follow the same approach but use module name instead of local path to the file. 

```js filename="/vovk.config.js"
/** @type {import('vovk').VovkConfig} */
const vovkConfig = {
    validateOnClient: 'my-validation-library/validateEqualityOnClient',
}

module.exports = vovkConfig;
```

Resulting client code is going to look like that:

```ts
import { HelloController } from 'vovk-client';

// ...

const result = await HelloController.validatedRequest({
    body: { foo: 42 },
    query: { bar: 'hello' },
});
```

`validateEqualityOnClient` is going to be invoked on every request before data is sent to the server.

