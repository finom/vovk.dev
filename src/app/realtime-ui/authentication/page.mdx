
# Basic Authentication and Authorization for Password Protection

The app implements a simple authentication mechanism with an optional `PASSWORD` stored in the `.env` file. Once the user enters the password, a session cookie is created that authorizes the user for further requests, making `userId` be a hashed version of the password. This allows to invalidate all sessions by changing the `PASSWORD` env variable in production.

The authentication is made by simplifying a solution provided at the official [Next.js authentication documentation](https://nextjs.org/docs/app/guides/authentication). It implements a [login page](https://github.com/finom/realtime-kanban/blob/main/src/app/login/page.tsx) with a form that invokes [login server action](https://github.com/finom/realtime-kanban/blob/main/src/app/actions/auth.ts). The session is created at [src/lib/session.ts](https://github.com/finom/realtime-kanban/blob/main/src/lib/session.ts) and Data Access Level file is defined at [src/lib/dal.ts](https://github.com/finom/realtime-kanban/blob/main/src/lib/dal.ts).

The DAL file, in its turn, exports `verifySession` function that is invoked at [page.tsx](https://github.com/finom/realtime-kanban/blob/main/src/app/page.tsx) and redirects the user to the login page if the session is invalid.

```ts showLineNumbers copy filename="src/lib/dal.ts" repository="finom/realtime-kanban"
import { cookies } from "next/headers";
import { cache } from "react";
import { redirect } from "next/navigation";
import crypto from "crypto";
import { decrypt } from "./session";

const getSession = async () => {
  const cookie = (await cookies()).get("session")?.value;
  const session = await decrypt(cookie);

  return session;
};

export const isLoggedIn = async () => {
  if (!process.env.PASSWORD) return true;
  const session = await getSession();
  const userId = crypto
    .createHash("md5")
    .update(process.env.PASSWORD)
    .digest("hex");
  return session?.userId === userId;
};

export const verifySession = cache(async () => {
  if (!(await isLoggedIn())) {
    redirect("/login");
  }
});
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/realtime-kanban/blob/main/src/lib/dal.ts)*

```ts showLineNumbers copy filename="src/app/page.tsx"
import { verifySession } from "@/lib/dal";

export default async function Home() {
  await verifySession();
  // ...
```

It also exports `isLoggedIn` function that is created for `sessionGuard` [decorator](/decorator) to check if the user is logged in when invoking procedures.

```ts showLineNumbers copy filename="src/decorators/sessionGuard.ts" repository="finom/realtime-kanban"
import { createDecorator, HttpException, HttpStatus } from "vovk";
import { isLoggedIn } from "@/lib/dal";

export const sessionGuard = createDecorator(async (req, next) => {
  if (typeof req.url !== "undefined" && !(await isLoggedIn())) {
    throw new HttpException(HttpStatus.UNAUTHORIZED, "Unauthorized");
  }
  return next();
});
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/realtime-kanban/blob/main/src/decorators/sessionGuard.ts)*


The `sessionGuard` decorator applied to all procedures. `typeof req.url !== 'undefined'{:ts}` check is required to distinguish between HTTP requests and [`fn`](/fn) invocations.
