# `fetcher`

The `fetcher` function implements `VovkClientFetcher<Options>` interface and defines how the client-side fetching is performed. By default, it uses the `fetch` function to make HTTP requests. It allows you to customize the request options and handle the response in a way that fits your application needs.

```ts
import { UserRPC } from 'vovk-client';

// ...
const user = await UserRPC.createUser({
  body,
  query,
  // custom options
  successToast: 'Successfully created a new user',
  useAuth: true,
  sentryLogErrors: true,
});
```

The fetcher accepts two arguments:

- An object that is provided by the internal Vovk.ts code that includes HTTP method information and utilities:
  - `httpMethod` - the HTTP metod;
  - `getEndpoint` - an utility that builds request endpoiint from `apiRoot`, `query` and `params`;
  - `validate` - a function that validates params, body and query of the request;
  - `defaultHandler` - handles the `Response` object returned from `fetch` function;
  - `defaultStreamHandler` - handles the `Response` object returned from `fetch` function in case of [JSONL stream](/streaming).
- Request arguments:
  - `params` - the input params such as `id` from `users/:id`;
  - `query` - the request query properties such as `?foo=bar`;
  - `body` - the request body;
  - `apiRoot` - by default it's `/api`; it can be redefined in the [config](/config) by setting `rootEntry` and `origin` properties that are concatenated to build the endpoint;
  - ...the rest options - your custom options.

Your custom fetcher with a custom option `successMessage` may look like that:

```ts filename="src/lib/fetcher.ts" {51}
import type { VovkDefaultFetcherOptions, VovkClientFetcher } from 'vovk';

// Define custom options
interface MyOptions extends VovkDefaultFetcherOptions {
  successMessage: string;
}

export const fetcher: VovkClientFetcher<MyOptions> = async (
  { httpMethod, getEndpoint, validate, defaultHandler, defaultStreamHandler },
  { params, query, body, apiRoot = '/api', successMessage, ...options }
) => {
  // Build the endpoint
  const endpoint = getEndpoint({ apiRoot, params, query });

  // Validate
  if (!options.disableClientValidation) {
    await validate({ params, body, query });
  }

  // Define RequestInit
  const init: RequestInit = {
    method: httpMethod,
    ...options.init,
    headers: {
      accept: 'application/jsonl, application/json',
      ...options.init?.headers,
    },
  };

  // Set the body
  if (body instanceof FormData) {
    init.body = body as BodyInit;
  } else if (body) {
    init.body = JSON.stringify(body);
  }

  const response = await fetch(endpoint, init);
  const contentType = options.interpretAs ?? response.headers.get('content-type');

  if (contentType?.startsWith('application/jsonl')) {
    // Handle JSON stream
    return defaultStreamHandler(response);
  }

  if (contentType?.startsWith('application/json')) {
    // Handle notmal JSON response
    return defaultHandler(response);
  }

  // Do something with custom options
  alert(successMessage);

  return response;
};
```

Check the default fetcher [source code on Github](https://github.com/finom/vovk/blob/main/packages/vovk/client/fetcher.ts).

The custom fetcher can be passed to the generated RPC function as `fetcher` option:

```ts {2,8-9}
import { UserRPC } from 'vovk-client';
import { fetcher } from '@/lib/fetcher';
// ...
await UserRPC.updateUser({
  body,
  query,
  params,
  fetcher,
  successMessage: 'Successfully updated user',
});
```

---

You can redefine the import path of the `fetcher` that is used at the generated RPC library.

```ts filename="vovk.config.mjs" {4}
/** @type {import('vovk').VovkConfig} */
const vovkConfig = {
  imports: {
    fetcher: './src/lib/fetcher.ts',
  },
};
export default vovkConfig;
```

This also can be done by setting `VOVK_IMPORTS_FETCHER` env variable:

```sh
VOVK_IMPORTS_FETCHER="./src/lib/fetcher" npx vovk dev
```

At this case RPCs imported from **vovk-client** will utilize the custom `fetcher` function.

```ts filename="./node_modules/.vovk-client/index.ts (rendered using 'ts' template)" {2}
import type { VovkClientFetcher } from 'vovk';
import { fetcher } from '../../src/lib/fetcher.ts';
import { createRPC } from 'vovk';
import { fullSchema } from './fullSchema.cjs';
import type { Controllers as Controllers0 } from '../../app/api/[[...vovk]]/route.ts';
import { validateOnClient } from 'vovk-ajv';

type Options = typeof fetcher extends VovkClientFetcher<infer U> ? U : never;
const apiRoot = '/api';

export const UserRPC = createRPC<Controllers0['UserRPC'], Options>(fullSchema, '', 'UserRPC', {
  fetcher,
  validateOnClient,
  defaultOptions: { apiRoot },
});
```

The `fetcher` function doesn't have to be passed to the generated RPC function manually anymore.

```ts {8}
import { UserRPC } from 'vovk-client';

// ...
await UserRPC.updateUser({
  body,
  query,
  params,
  successMessage: 'Successfully updated user',
});
```