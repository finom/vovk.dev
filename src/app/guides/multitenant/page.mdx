import { Steps } from 'nextra/components'

# Multitenacy

Next.js has built-in support for multitenancy, using [middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware) to handle tenant-specific routing. https://nextjs.org/docs/app/api-reference/file-conventions/dynamic-routes


Vovk.ts provides a tiny routing utility `multitenant` that accepts request information and returns the action to take, such as redirecting to a specific subdomain or rewriting the request to a different path. The actions themselves need to be implemented manually.

<Steps>
## Configure DNS

## Structure front-end routes

## Create back-end API segments and configure URLs

## Create middleware 
</Steps>

The function accepts the following parameters:
- `requestUrl`: the URL of the request, including the protocol, host, and path, can be obtained from `request.url`.
- `requestHost`: the host of the request, can be obtained from `request.headers.get("host")`.
- `targetHost`: the host to which the request should be redirected or rewritten, can be set to your production domain or `localhost:3000` for local development.
- `overrides`: an object that maps tenant subdomain domain names to their specific routing rules. Each rule is an array of objects with `from` and `to` properties, where `from` is the path prefix to match and `to` is the path to which the request should be rewritten or redirected.

```ts filename="src/app/middleware.ts"
import { NextRequest, NextResponse } from "next/server";
import { multitenant } from "vovk";

export default function middleware(request: NextRequest) {
  const { action, destination, message, subdomains } = multitenant({
    requestUrl: request.url,
    requestHost: request.headers.get("host") ?? "",
    targetHost: process.env.NODE_ENV === "production" ? "multitenant.vovk.dev" : "localhost:3000",
    overrides: {
      "[customer_name].customer": [
        { from: "api", to: "api/customer" }, // API
        { from: "", to: "[customer_name]" }, // UI
      ],
      "pro.[customer_name].customer": [
        { from: "api", to: "api/customer/pro" }, // API
        { from: "", to: "pro/[customer_name]" }, // UI
      ],
      admin: [
        { from: "api", to: "api/admin" }, // API
        { from: "", to: "admin" }, // UI
      ],
    },
  });

  console.log({
    url: request.url,
    action,
    destination,
    message,
    subdomains,
  });

  let res: NextResponse;
  if (action === "rewrite" && destination) {
    res = NextResponse.rewrite(new URL(destination));
  } else if (action === "redirect" && destination) {
    res = NextResponse.redirect(new URL(destination));
  } else if (action === "notfound") {
    res = new NextResponse("Not Found", { status: 404 });
  } else {
    res = NextResponse.next();
  }

  if (subdomains) {
    res.cookies.set(
      "x-subdomains",
      new URLSearchParams(subdomains).toString(),
      { expires: new Date(Date.now() + 3e4) },
    );
  }

  return res;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico, sitemap.xml, robots.txt (metadata files)
     * - SVG files
     */
    "/((?!static|.*\\.png|.*\\.svg|.*\\.ico|.well-known|_next/image|_next/static).*)",
  ],
};
```