# TypeScript RPC Customization

The generated TypeScript library is customized by replacing imports of lower-level libraries. This can be done by modifying the `imports` object in the [config](/config) file, which may contain [fetcher](#fetcher), [validateOnClient](#validateonclient), or [createRPC](#createrpc-advanced).

By default (if [vovk-ajv](/validation/client) is used for client-side validation), an `index.mjs` file that generates the `UserRPC` module might look like this:

```ts filename="./node_modules/.vovk-client/index.mjs"
import { createRPC } from 'vovk';
import { schema } from './schema.cjs';

export const UserRPC = createRPC(schema, '', 'UserRPC', import('vovk'), {
  validateOnClient: import('vovk-ajv'),
  apiRoot: 'http://localhost:3000/api',
});
```

When the `outputConfig.imports` are modified:

```ts filename="vovk.config.mjs"
/** @type {import('vovk').VovkConfig} */
const config = {
  outputConfig: {
    imports: {
      fetcher: './src/lib/fetcher',
      validateOnClient: './src/lib/validateOnClient',
      createRPC: './src/lib/createRPC',
    },
  }
};
export default config;
```

The generated `index.mjs` file will use these imports and apply relative paths:

```ts filename="./node_modules/.vovk-client/index.mjs"
import { createRPC } from '../../src/lib/createRPC';

export const UserRPC = createRPC(schema, '', 'UserRPC', import('../../src/lib/fetcher'), {
  validateOnClient: import('../../src/lib/validateOnClient'),
  apiRoot: 'http://localhost:3000/api',
});
```

`fetcher` and `validateOnClient` can also be set individually for each [segment](/segment). The first one enables you to have different sets of options or authorization mechanisms for different segments (including [OpenAPI mixins](/codegen)). The second one allows you to use different validation libraries for different segments.

```ts
/** @type {import('vovk').VovkConfig} */
const config = {
  outputConfig: {
    imports: { // applied to all segments
      fetcher: './src/lib/fetcher',
      validateOnClient: './src/lib/validateOnClient',
    },
    segments: {
      admin: {
        imports: { // applied only to "admin" segment
          fetcher: './src/lib/adminFetcher',
          validateOnClient: './src/lib/adminValidateOnClient',
        },
      },
    }
  }
};
export default config;
```

## `fetcher`

The `fetcher` is a function used to prepare handlers, perform client-side validation, make HTTP requests, distinguish between content types (whether it's JSON, [JSON Lines](/streaming), or another kind of `Response` object), and return the response in the proper format.

- If the content type is `application/json`, it will return the parsed JSON object.
- If the content type is `application/jsonl` or `application/jsonlines`, it will return a disposable async iterable.
- For other content types, it will return the `Response` object as is, where you can access text or binary data.

It can also handle custom options that are passed to the RPC method.

```ts
import { UserRPC } from 'vovk-client';

const user = await UserRPC.updateUser({
  // ...
  successMessage: 'Successfully updated the user',
  someOtherCustomFlag: true,
});
```

### `createFetcher`

The path to the file defined at `imports.fetcher` needs to export a `fetcher` variable. To simplify the creation of a custom fetcher, you can use the `createFetcher` function exported from the `vovk` package.

```ts filename="./src/lib/fetcher.ts"
import { createFetcher } from 'vovk';

export const fetcher = createFetcher<{
  successMessage?: string; // "Successfully created a new user"
  useAuth?: boolean; // if true, Authorization header will be set
  someOtherCustomFlag?: boolean; // any custom flag that you want to pass to the RPC method
}>({
  prepareRequestInit: async (init, { useAuth, someOtherCustomFlag }) => {
    // ...
    return {
      ...init,
      headers: {
        ...init.headers,
        ...(useAuth ? { Authorization: 'Bearer token' } : {}),
      },
    };
  },
  transformResponse: async (data, { someOtherCustomFlag }) => {
    // ...
    return {
      ...data,
    };
  },
  onSuccess: async (data, { successMessage }) => {
    if (successMessage) {
      alert(successMessage);
    }
  },
  onError: async (error) => {
    alert(error.message);
  },
});
```

This will result in all RPC modules accepting the desired options:

```ts
import { UserRPC } from 'vovk-client';

await UserRPC.updateUser({
  params: { param: 'value' },
  query: { id: 'value' },
  body: { email: 'value' },
  successMessage: 'Successfully updated the user',
  useAuth: true,
  someOtherCustomFlag: true,
});
```

`createFetcher` accepts an object with the following members:

#### `prepareRequestInit(init: RequestInit, options: T){:ts}`

This function is used to prepare the `RequestInit` object before making the HTTP request. It can be used to set authorization headers or Next.js-specific options defined as the `next` property in the `RequestInit` object. It accepts the `init` object that is prepared for the request (has body, headers, etc.) and the `options` object that contains custom options passed to the RPC method. The function must return a `RequestInit` object that can be built upon the original `init` object. The function can also be used for any other logic that needs to be executed before the request is made, such as logging.

#### `transformResponse(data: unknown, options: T, info: { response: Response, init: RequestInit, schema: VovkHandlerSchema }){:ts}`

This function is used to transform the response data before it is returned to the caller. It can be used to post-process received data. The data type is defined by the received content-type header, so it can be a JSON object, a [disposable](https://github.com/tc39/proposal-explicit-resource-management) [async iterator](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncIterator), or a `Response` object. The function should return the transformed data that will be received by the caller.

The third argument `info` contains additional information about the request, including the original `Response` object, the `RequestInit` object used for the request, and the `VovkHandlerSchema` that describes the handler being called, such as `schema.operationObject`.

#### `onError(error: HttpException, options: T){:ts}`

This function is called when an error occurs during the request. It can be used to show error messages, perform logging, or handle any other error handling that needs to be done.

#### `onSuccess(data: unknown, options: T){:ts}`

This function is called when the request is successful. It can be used to show success messages, perform logging, or handle any other success handling that needs to be done.

## `validateOnClient`

The `validateOnClient` function is used to define how client-side validation should be performed for the RPC method input (`params`, `query`, and `body`). It can be created with the `createValidateOnClient` function exported from the `vovk` package. It accepts a `validate` property that receives one of the input data, validation schema, and some additional options, and returns the validated data or throws an error if validation fails. Validation is performed only when both input and schema are provided.

```ts filename="./src/lib/validateOnClient.ts"
import { validateData } from 'validation-library';
import { createValidateOnClient, HttpException, HttpStatus } from 'vovk';

export const validateOnClient = createValidateOnClient({
  validate: async (input, schema, meta) => {
    const isValid = validateData(input, schema);
    if (!isValid) {
      throw new HttpException(HttpStatus.NULL, 'Validation failed', {
        // ... optional cause
      });
    }

    return input;
  },
});
```

For more details on client-side validation, see the [client-side validation](/validation/client) page.

## `createRPC` (Advanced)

The `createRPC` customization can be used to replace the default RPC client completely and can be configured globally only, not per-segment (as you can do for `fetcher` or `validateOnClient`). It's an advanced feature with no known use case so far. Feel free to ask on [GitHub Discussions](https://github.com/finom/vovk/discussions).
