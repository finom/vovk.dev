import { Tabs } from 'nextra/components';
import StreamJSONResponseObjectController from '../../../downloaded-examples/stream-response-object/StreamResponseObjectController.mdx';
import StreamService from '../../../downloaded-examples/stream-response-object/StreamService.mdx';
import StreamExample from '../../../downloaded-examples/stream-response-object/StreamExample.mdx';
import LiveStreamJSONResponseExample from '../../../live-examples/LiveStreamResponseExample';

# `StreamJSONResponse` class

Quick demo:

<div className="doc-live-example">
  <LiveStreamJSONResponseExample />
</div>

[Source code](https://vovk-examples.vercel.app/stream-response-object)

If generators aren't sutable for JSON streaming at a particular case, you can use `StreamJSONResponse` class inherited from `Response` class that uses `TransformStream#readable` as response body and adds required HTTP headers.
It's a lower-level API that is used behind the scenes to implement generator logic described at [the main section](/streaming).
A service method at this case is implemented as a regular function that accepts `StreamJSONResponse` instance as a pointer to send messages manually.

There is what the streaming service might look like:

```ts filename="/src/modules/stream/StreamService.ts"
import type { StreamJSONResponse } from 'vovk';

export type Token = { message: string };

export default class StreamService {
  static async streamTokens(resp: StreamJSONResponse<Token>) {
    const tokens: Token[] = [{ message: 'Hello,' }, { message: ' World' }, { message: '!' }];

    for (const token of tokens) {
      await new Promise((resolve) => setTimeout(resolve, 300));
      resp.send(token);
    }

    resp.close();
  }
}
```

As you can see tokens are sent using `StreamJSONResponse#send` method and, when the stream is completed, it needs to be closed with `StreamJSONResponse#close`.

The controller class returns an instance of `StreamJSONResponse` and the streaming is performed a floating Promise above the `return` statement.

```ts
import { prefix, get, StreamJSONResponse, type VovkRequest } from 'vovk';
import StreamService, { type Token } from './StreamService';

@prefix('stream')
export default class StreamController {
  @get('tokens')
  static async streamTokens() {
    const resp = new StreamJSONResponse<Token>();

    void StreamService.streamTokens(resp);

    return resp;
  }
}
```

`StreamJSONResponse` class also provides `throw` method that safely closes the stream and makes the client to re-throw the received error.

```ts
await resp.throw(new Error('Stream error'));
```
