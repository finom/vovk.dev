
import { Tabs, Callout } from 'nextra/components';
import LiveStreamExample from '../live-examples/LiveStreamExample';

# JSON streaming for LLMs

Quick demo:

<div className="doc-live-example">
    <LiveStreamExample />
</div>

[Source code](https://vovk-examples.vercel.app/stream)

## Async iterators

Controller methods can implement generators that use `*` syntax and utilise `yield` keyword instead of the regular `return`.

```ts filename="/src/modules/stream/StreamController.ts"
import { get, prefix } from 'vovk';

type Token = { message: string };

@prefix('stream')
export default class StreamController {
  @get('tokens')
  static async *streamTokens() {
    const tokens: Token[] = [
      { message: 'Hello,' },
      { message: ' World' },
      { message: '!' },
    ];

    for (const token of tokens) {
      await new Promise((resolve) => setTimeout(resolve, 300));
      yield token;
    }
  }
}
```

In order to refactor this code and utilise [service class](/service) for code splitting, you can move the streaming logic to `StreamService` static class.

```ts filename="/src/modules/stream/StreamService.ts"
type Token = { message: string };

export default class StreamService {
  static async *streamTokens() {
    const tokens: Token[] = [
      { message: 'Hello,' },
      { message: ' World' },
      { message: '!' },
    ];

    for (const token of tokens) {
      await new Promise((resolve) => setTimeout(resolve, 300));
      yield token;
    }
  }
}
```

At the controller use `yield*` syntax to delegate iterable returned from `StreamService.streamTokens`.

```ts filename="/src/modules/stream/StreamController.ts"
import { get, prefix } from 'vovk';
import StreamService from './StreamService';

@prefix('stream')
export default class StreamController {
  @get('tokens')
  static async *streamTokens() {
    yield* StreamService.streamTokens();
  }
}
```

## Handling on the client

<Callout type="warning" emoji="⚠️">
    **Workaround notice**. In order to identify the stream response type, Vovk.ts internally uses a custom header `x-vovk-stream=true` and content-type `text/plain; charset=utf-8`.
</Callout>

JSON streaming endpoints (including usage of [StreamJSONResponse](/streaming/stream-response) class that works under the hood of this feature) generate client methods that return disposable/async-disposable async generators. 

```ts
import { StreamRPC } from 'vovk-client';

async function stream() {
    using stream = await StreamRPC.streamTokens();

    for await (const token of stream) {
        console.log(token);
    }
}
```

You can also use `await using` syntax to dispose the stream asynchronously.

```ts
// ...
await using stream = await StreamRPC.streamTokens();
```

