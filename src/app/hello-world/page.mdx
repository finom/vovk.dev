import { Tabs } from 'nextra/components';
import GithubFiles from '@/components/GithubFiles';
import IFrame from './IFrame';

# "Hello World" showcase

The "Hello World" app is a Next.js/Vovk.ts project example that showcases some of the core features of Vovk.ts by implementing an HTML form with some extra features. It implements `UserController` with an `updateUser` method served as `POST` to `/api/users/{id}` endpoint, `StreamController` with a JSONLines handler `streamTokens` served as `GET` to `/api/streams/tokens` endpoint, but also `OpenApiController` with `getSpec` method served as `GET` to `/api/static/openapi/spec.json` endpoint that provides an OpenAPI specification for the API from a static segment. The OpenAPI documentation can be viewed at [`/openapi` page](https://hello-world.vovk.dev/openapi).

The project can be explored at the [GitHub repository](https://github.com/finom/vovk-hello-world) and viewed live at [hello-world.vovk.dev](https://hello-world.vovk.dev/). Bundled and generated files are available in the Git index as [dist](https://github.com/finom/vovk-hello-world/tree/main/dist), [dist_rust](https://github.com/finom/vovk-hello-world/tree/main/dist_rust) and [dist_python](https://github.com/finom/vovk-hello-world/tree/main/dist_python), so you can explore (usually they should be `.gitignore`'d). 

All code snippets on this page directly pulled from the source code on Github and HTML pages are served within an iframe.

## Topics/concepts covered 

- [Zod validation](/validation/zod), with a `body`, `query` and `params` inputs and schema descriptions using Zod's [meta](https://zod.dev/metadata#meta) method.
- [Client-side validation](/validation/client) for RPC method requests.
- [Composed](/composed) & [segmented](/segmented) [TypeScript](/typescript) client.
- [JSONLines](/controller/jsonlines) streaming.
- [Type inference](/inference) in a [service](/controller/service), while [controller](/controller) method returns service's method result.
- `useQuery` and `useMutation` usage with [queryKey](/typescript#react-query) method.
- [Generation](/codegen) of [Rust](/rust) and [Python](/python) clients with README, published on [Crates.io](https://crates.io/crates/vovk_hello_world) and [PyPI](https://pypi.org/project/vovk-hello-world/).
- TypeScript client [bundle](/bundle) with README, published on [NPM](https://www.npmjs.com/package/vovk-hello-world).
- [OpenAPI spec](/openapi) with code samples served from [static](/segment/static) [segment](/segment/introduction) using [Scalar](https://scalar.com/).


## Live Demo

The demo below implements a simple form without validation attributes with "Disable client-side input validation" checkbox that represents [disableClientValidation](/typescript#disableclientvalidation) option.

<IFrame src="https://hello-world.vovk.dev" width="100%" height="780px"></IFrame>

## `UserController` and `UserService`

The `/api/users/{id}` endpoint is implemented by the `UserController` and `UserService` classes that provide `updateUser` method. 

The controller's `updateUser` method is implemented with `@post` decorator that maps the method to the `POST` HTTP verb, and `withZod` function that applies [Zod validation](/validation/zod) to the request input (`body`, `params`, and `query`). The input Zod models use `meta` method to provide additional metadata for the OpenAPI specification. 

For deminstrational purposes, the `body` input model implements nested validation of `email` and `profile` fields, where `profile` is an object with `name` and `age` properties.

The service `updateUser` method infers the input type from the controller method that in its turn returns the result of the service's `updateUser` method call, demonstrating lack of self-reference errors (implicit "any"). In other words, the controller's input type is being a source of truth for the service's input arguments, and the service's return type is inferred from the controller's output type.

<Tabs items={['UserController.ts', 'UserService.ts']}>
<Tabs.Tab>
```ts showLineNumbers copy filename="src/modules/user/UserController.ts" repository="finom/vovk-hello-world"
import { z } from "zod";
import { prefix, post, operation } from "vovk";
import { withZod } from "vovk-zod";
import UserService from "./UserService";

@prefix("users")
export default class UserController {
  @operation({
    summary: "Update user",
    description: "Update user by ID",
  })
  @post("{id}")
  static updateUser = withZod({
    body: z
      .object({
        email: z.email().meta({
          description: "User email",
          examples: ["john@example.com", "jane@example.com"],
        }),
        profile: z
          .object({
            name: z.string().meta({
              description: "User full name",
              examples: ["John Doe", "Jane Smith"],
            }),
            age: z
              .int()
              .min(16)
              .max(120)
              .meta({ description: "User age", examples: [25, 30] }),
          })
          .meta({ description: "User profile object" }),
      })
      .meta({ description: "User data object" }),
    params: z
      .object({
        id: z.uuid().meta({
          description: "User ID",
          examples: ["123e4567-e89b-12d3-a456-426614174000"],
        }),
      })
      .meta({
        description: "Path parameters",
      }),
    query: z
      .object({
        notify: z
          .enum(["email", "push", "none"])
          .meta({ description: "Notification type" }),
      })
      .meta({
        description: "Query parameters",
      }),
    output: z
      .object({
        success: z.boolean().meta({ description: "Success status" }),
        id: z.uuid().meta({ description: "User ID" }),
        notify: z.enum(["email", "push", "none"]).meta({
          description: "Notification type",
        }),
      })
      .meta({ description: "Response object" }),
    async handle(req, { id }) {
      const body = await req.json();
      const notify = req.nextUrl.searchParams.get("notify");

      return UserService.updateUser(id, body, notify);
    },
  });
}
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/modules/user/UserController.ts)*
</Tabs.Tab>
<Tabs.Tab>
```ts showLineNumbers copy filename="src/modules/user/UserService.ts" repository="finom/vovk-hello-world"
import type { VovkBody, VovkOutput, VovkParams, VovkQuery } from "vovk";
import type UserController from "./UserController";

export default class UserService {
  static updateUser = (
    id: VovkParams<typeof UserController.updateUser>["id"],
    body: VovkBody<typeof UserController.updateUser>,
    notify: VovkQuery<typeof UserController.updateUser>["notify"],
  ) => {
    console.log(
      id satisfies string,
      body satisfies { email: string; profile: { name: string; age: number } },
      notify satisfies "email" | "push" | "none",
    );
    return {
      id,
      notify,
      success: true,
    } satisfies VovkOutput<typeof UserController.updateUser>;
  };
}
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/modules/user/UserService.ts)*
</Tabs.Tab>
</Tabs>

## `StreamController` and `StreamService`

The `/api/streams/tokens` endpoint is implemented by the `StreamController` and `StreamService` classes that provide `streamTokens` method.

The controller `streamTokens` method is implemented with `@get` decorator that maps the method to the `GET` HTTP verb, and `withZod` function that validates iterations of [JSONLines](/controller/jsonlines) responses. It delegates iterable execution with `yield*` syntax to the service's `streamTokens` method, which is a generator function that yields tokens one by one. It uses `setTimeout` to simulate a delay between token emissions, demonstrating how to handle streaming responses in Vovk.ts.

<Tabs items={['StreamController.ts', 'StreamService.ts']}>
<Tabs.Tab>
```ts showLineNumbers copy filename="src/modules/stream/StreamController.ts" repository="finom/vovk-hello-world"
import { prefix, get, operation } from "vovk";
import { withZod } from "vovk-zod";
import { z } from "zod";
import StreamService from "./StreamService";

@prefix("streams")
export default class StreamController {
  @operation({
    summary: "Stream tokens",
    description: "Stream tokens to the client",
  })
  @get("tokens")
  static streamTokens = withZod({
    iteration: z
      .object({
        message: z.string().meta({ description: "Message from the token" }),
      })
      .meta({
        description: "Streamed token object",
      }),
    async *handle() {
      yield* StreamService.streamTokens();
    },
  });
}
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/modules/stream/StreamController.ts)*
</Tabs.Tab>
<Tabs.Tab>
```ts showLineNumbers copy filename="src/modules/stream/StreamService.ts" repository="finom/vovk-hello-world"
import type { VovkIteration } from "vovk";
import type StreamController from "./StreamController";

export default class StreamService {
  static async *streamTokens() {
    const tokens: VovkIteration<typeof StreamController.streamTokens>[] =
      "Vovk.ts is a RESTful back-end meta-framework with RPC built on top of Next.js App router, and this text is a JSONLines stream demo."
        .match(/[^\s.-]+|\s+|\.|-/g)
        ?.map((message) => ({ message })) || [];

    for (const token of tokens) {
      yield token;
      await new Promise((resolve) => setTimeout(resolve, 100));
    }
  }
}
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/modules/stream/StreamService.ts)*
</Tabs.Tab>
</Tabs>

## React Components

The components in the demo use [@tanstack/react-query](https://www.npmjs.com/package/@tanstack/react-query) for data fetching.

<Tabs items={['index.tsx', 'UserFormDemo.tsx', 'StreamDemo.tsx']}>
<Tabs.Tab>
```ts showLineNumbers copyx showLineNumbers copy filename="src/components/Demo/index.tsx" repository="finom/vovk-hello-world"
"use client";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import StreamDemo from "./StreamDemo";
import UserFormDemo from "./UserFormDemo";

const queryClient = new QueryClient();

const Demo = () => {
  return (
    <QueryClientProvider client={queryClient}>
      <StreamDemo />
      <h2 className="text-lg font-bold mb-1 text-center">
        &quot;Update user&quot; demo
      </h2>
      <p className="text-xs mb-4 text-center">
        <strong>*</strong> form validation isn&apos;t enabled for demo purposes
      </p>
      <UserFormDemo />
    </QueryClientProvider>
  );
};

export default Demo;
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/components/Demo/index.tsx)*
</Tabs.Tab>
<Tabs.Tab>
```ts showLineNumbers copyx showLineNumbers copy filename="src/components/Demo/UserFormDemo.tsx" repository="finom/vovk-hello-world"
"use client";
import React, { useState } from "react";
import { type VovkQuery } from "vovk";
import { UserRPC } from "../../client/root"; // segmented client
import { useMutation } from "@tanstack/react-query";

const UserFormDemo = () => {
  const [disableClientValidation, setDisableClientValidation] = useState(false);
  const [name, setName] = useState("John Doe");
  const [age, setAge] = useState(35);
  const [email, setEmail] = useState("john@example.com");
  const [id, setId] = useState("a937629d-e8f6-4b1e-a819-7669358650a0");
  const updateUserMutation = useMutation({
    mutationFn: UserRPC.updateUser,
  });
  const [notify, setNotify] = useState<
    VovkQuery<typeof UserRPC.updateUser>["notify"]
  >(
    "sms" as "email", // set error value by default
  );

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    updateUserMutation.mutate({
      body: {
        email,
        profile: {
          name,
          age,
        },
      },
      query: { notify },
      params: { id },
      disableClientValidation,
    });
  };
  return (
    <form onSubmit={handleSubmit}>
      <h3>Body</h3>
      <div>
        <label>User email</label>
        <input
          name="email"
          placeholder="john@example.com"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />
      </div>
      <div>
        <label>User full name</label>
        <input
          name="name"
          type="text"
          placeholder="John Doe"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
      </div>
      <div>
        <label>User age</label>
        <input
          name="age"
          type="number"
          placeholder="35"
          value={age}
          onChange={(e) => setAge(Number(e.target.value))}
        />
      </div>

      <h3>Params</h3>
      <div>
        <label>User ID</label>
        <input
          name="id"
          type="text"
          placeholder="123e4567-e89b-12d3-a456-426614174000"
          value={id}
          onChange={(e) => setId(e.target.value)}
        />
      </div>
      <h3>Query</h3>
      <div>
        <label>Notification type</label>
        <select
          name="notify"
          value={notify}
          onChange={(e) =>
            setNotify(e.target.value as "email" | "push" | "none")
          }
        >
          <option value="none">None</option>
          <option value="email">Email</option>
          <option value="push">Push</option>
          <option value="sms">SMS (error)</option>
        </select>
      </div>
      <br />
      <label>
        <input
          type="checkbox"
          onChange={({ target }) => setDisableClientValidation(target.checked)}
          checked={disableClientValidation}
        />{" "}
        Disable client-side input validation
      </label>
      <button type="submit">Submit</button>
      {(updateUserMutation.data || updateUserMutation.error) && (
        <output>
          <strong>Response:</strong>{" "}
          {updateUserMutation.error ? (
            <div className="text-red-500">
              {updateUserMutation.error.message}
            </div>
          ) : (
            <div className="text-green-500">
              {JSON.stringify(updateUserMutation.data)}
            </div>
          )}
        </output>
      )}
    </form>
  );
};

export default UserFormDemo;
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/components/Demo/UserFormDemo.tsx)*
</Tabs.Tab>
<Tabs.Tab>
```ts showLineNumbers copyx showLineNumbers copy filename="src/components/Demo/StreamDemo.tsx" repository="finom/vovk-hello-world"
"use client";
import {
  useQuery,
  experimental_streamedQuery as streamedQuery,
} from "@tanstack/react-query";
import { StreamRPC } from "../../client/root"; // segmented client

const StreamDemo = () => {
  const { data } = useQuery({
    queryKey: StreamRPC.streamTokens.queryKey(),
    queryFn: streamedQuery({
      streamFn: () => StreamRPC.streamTokens(),
    }),
  });

  return (
    <div className="h-20">
      {data?.map((token, index) => (
        <span key={index}>{token.message}</span>
      ))}
    </div>
  );
};
export default StreamDemo;
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/components/Demo/StreamDemo.tsx)*
</Tabs.Tab>
</Tabs>

## Config

The app is [configured](/config) to:

- Handle client-side validation with [Ajv](/validation/client).
- Generate [Rust](/rust) and [Python](/python) code automatically when [vovk dev](/dev) command is run.
- Demonstrate [segmented client](/segmented), so the RPC modules are generated in separate files for each [segment](/segment).
- Bundle with a proper `origin`.

If you use default config settings, you can generate the client for other languages with:

```sh npm2yarn copy
npx vovk generate --from rs --from py --origin https://hello-world.vovk.dev
```

And the bundle with:

```sh npm2yarn copy
npx vovk bundle --origin https://hello-world.vovk.dev
```

```ts showLineNumbers copy filename="vovk.config.js" repository="finom/vovk-hello-world"
// @ts-check

const PROD_ORIGIN = "https://hello-world.vovk.dev";
// Commented lines indicate default values
/** @type {import('vovk').VovkConfig} */
const config = {
  logLevel: "debug",
  outputConfig: {
    origin: process.env.NODE_ENV === "production"
      ? PROD_ORIGIN
      : `http://localhost:${process.env.PORT ?? 3000}`,
    imports: {
      validateOnClient: "vovk-ajv",
    },
    openAPIObject: {
      info: {
        title: '"Hello World" app API',
        description:
          'API for "Hello World" app hosted at https://hello-world.vovk.dev/. Source code is available on Github https://github.com/finom/vovk-hello-world.',
        license: {
          name: "MIT",
          url: "https://opensource.org/licenses/MIT",
        },
        version: "1.0.0",
      },
    }
  },
  composedClient: {
    fromTemplates: ["mjs", "cjs", "py", "rs"],
    // enabled: true,
    // outDir: "./node_modules/.vovk-client",
  },
  segmentedClient: {
    // fromTemplates: ["ts"],
    enabled: true,
    // outDir: "./src/client",
  },
  bundle: {
    outputConfig: { origin: PROD_ORIGIN },
    keepPrebundleDir: true,
    build: async ({ entry, outDir }) => {
      const { build } = await import('tsdown');
      await build({
        entry,
        dts: true,
        format: ['cjs', 'esm'],
        hash: false,
        fixedExtension: true,
        clean: true,
        outDir,
        tsconfig: './tsconfig.bundle.json',
      });
    },
  },
  clientTemplateDefs: {
    py: {
      extends: "py",
      outputConfig: { origin: PROD_ORIGIN },
      // composedClient: { outDir: "./dist_python" },
    },
    rs: {
      extends: "rs",
      outputConfig: { origin: PROD_ORIGIN },
      // composedClient: { outDir: "./dist_rust" },
    },
  }
};

module.exports = config;
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/vovk.config.js)*

<a name="bundle" />
## Building and Packaging

The example also demonstrates the ability to quickly create a distributable package, published on [npm](https://www.npmjs.com/package/vovk-hello-world), [PyPI](https://pypi.org/project/vovk-hello-world/) and [crates.io](https://crates.io/crates/vovk_hello_world). The [templates](/templates) offered in the framework compile a ready-to-use packages with corresponding files for each language, such as [package.json](https://github.com/finom/vovk-hello-world/blob/main/dist/package.json), [Cargo.toml](https://github.com/finom/vovk-hello-world/blob/main/dist_rust/Cargo.toml), and [pyproject.toml](https://github.com/finom/vovk-hello-world/blob/main/dist_python/pyproject.toml), but also the `README.md` files that follow the idea of documenting the API as RPC method calls with comments as method descriptions and examples at the same time.

On the root of the "hello world" project in the `package.json` file, you can find the `scripts` section with the following self-explanatory commands:

```json
"scripts": {
    // ...
    "postversion:ts": "npm run bundle && npm publish ./dist",
    "postversion:rs": "cargo publish --manifest-path dist_rust/Cargo.toml --allow-dirty",
    "postversion:py": "python3 -m build ./dist_python --wheel --sdist && python3 -m twine upload ./dist_python/dist/*",
    "postversion": "vovk generate && npm run postversion:ts && npm run postversion:rs && npm run postversion:py && git push && git push --tags",
    "patch": "npm version patch"
}
```

And once you run `npm version patch`, it will automatically generate packages for TypeScript, Rust, and Python, and publish the packages to npm, crates.io, and PyPI. The `README.md` files are also updated with the latest examples and descriptions.

The examples below are rendered from the READMEs on Github Pages.

<Tabs items={['TypeScript', 'Rust', 'Python']}>
<Tabs.Tab>
<IFrame src="https://finom.github.io/vovk-hello-world/dist/" width="100%" height="1000px"></IFrame>
</Tabs.Tab>
<Tabs.Tab>
<IFrame src="https://finom.github.io/vovk-hello-world/dist_rust/" width="100%" height="1000px"></IFrame>
</Tabs.Tab>
<Tabs.Tab>
<IFrame src="https://finom.github.io/vovk-hello-world/dist_python/" width="100%" height="1000px"></IFrame>
</Tabs.Tab>
</Tabs>

## Node.js, Rust and Python Demo

The app also includes a demo of how the RPC methods can be run in Node.js, Rust, and Python. Each demo showcases how to use the generated client to call the `updateUser`, `streamTokens`, `getSpec` (for static OpenAPI RPC) but also call the `getSpec` method of the published API.

The demo can be seen by running `npm run dev` in one terminal instance and `npm run demo` in another terminal instance.

The `demo` scripts are self-explanatory and can be found in the `package.json` file:

```json
"scripts": {
    // ...
    "demo": "npm run demo:ts && npm run demo:rs && npm run demo:py",
    "demo:ts": "node --experimental-strip-types demo_node/index.mts",
    "demo:rs": "cargo run --manifest-path ./demo_rust/Cargo.toml --quiet",
    "demo:py": "python3 -m pip install --upgrade vovk_hello_world --quiet && python3 demo_python.py",
}
```

<Tabs items={['index.mts', 'demo_python.py', 'main.rs']}>
<Tabs.Tab>
```ts showLineNumbers copy filename="demo_node/index.mts"
// TODO
```
</Tabs.Tab>
<Tabs.Tab>
```ts showLineNumbers copy filename="demo_python.py"
// TODO
```
</Tabs.Tab>
<Tabs.Tab>
```ts showLineNumbers copy filename="demo_rust/src/main.rs"
// TODO
```
</Tabs.Tab>
</Tabs>

## OpenAPI specification

[OpenAPI specification](https://hello-world.vovk.dev/api/static/openapi/spec.json) requires creating another `GET` endpoint that uses `vovkSchemaToOpenAPI` function to generate the OpenAPI spec from the Vovk.ts [schema](/schema).


```ts showLineNumbers copy filename="src/modules/static/openapi/OpenApiController.ts" repository="finom/vovk-hello-world"
import { get, operation } from "vovk";
import { openapi } from "vovk-client/openapi";

export default class OpenApiController {
  @operation({
    summary: "OpenAPI spec",
    description: 'Get the OpenAPI spec for the "Hello World" app API',
  })
  @get("openapi.json", { cors: true })
  static getSpec = () => openapi;
}
```
*[The code above is fetched from GitHub repository.](https://github.com/finom/vovk-hello-world/blob/main/src/modules/static/openapi/OpenApiController.ts)*

The generated specification also includes the [Scalar](https://scalar.com/) compatible examples that can be copied and pasted to your project stright away.

<IFrame src="https://hello-world.vovk.dev/openapi" width="100%" height="1000px"></IFrame>

## Conclusion

Besides being a back-end framework for Next.js, Vovk.ts offers extra features that ususally require extra skills and time to implement, such as:

- Beautifully documented OpenAPI specification powered by [Scalar](https://scalar.com/).
- RPC library that has the same shape as controllers, inferring types from the controller methods.
- Client-side validation with [Ajv](/validation/client) for immediate feedback.
- JSON streaming implementation with [JSONLines](/controller/jsonlines).
- Code generation and bundling to quickly publish the documented RESTful API library.