import { FileTree } from 'nextra/components';

# Schema

The `npm run dev` command runs [vovk dev](/dev) together with `next dev` via [concurrently](https://www.npmjs.com/package/concurrently). The first command watches for changes in the `modules` folder, looking for updates to controller methods and their [validation](/validation). On the initial run, or when a change is detected, it makes an HTTP request to the Next.js dev server's `_schema_` endpoint of the corresponding segment, which is exposed only when `process.env.NODE_ENV` is set to `development`. The endpoint returns the schema for the corresponding segment only, allowing emitted .json files to be isolated from each other. This approach works even in [Edge Runtime](https://edge-runtime.vercel.app/), since `route.ts` files don't need to import Node.js modules such as `fs`.

Each segment emits its back-end schema into an individual JSON file, which is then used to generate client-side RPC modules. If you have different areas of your application (e.g., root, admin, customer), each area will have its own JSON schema file.

For a segment structure like this:

<FileTree>
  <FileTree.Folder name="src/app/api" defaultOpen>
    <FileTree.Folder name="[[...vovk]]" defaultOpen>
      <FileTree.File
        name={
          <span>
            route.ts{' '}
            <span className="text-gray-500">
              (root segment <code>/api/</code>)
            </span>
          </span>
        }
      />
    </FileTree.Folder>
    <FileTree.Folder name="admin/[[...vovk]]" defaultOpen>
      <FileTree.File
        name={
          <span>
            route.ts{' '}
            <span className="text-gray-500">
              (admin segment <code>/api/admin</code>)
            </span>
          </span>
        }
      />
    </FileTree.Folder>
    <FileTree.Folder name="customer/[[...vovk]]" defaultOpen>
      <FileTree.File
        name={
          <span>
            route.ts{' '}
            <span className="text-gray-500">
              (customer segment <code>/api/customer</code>)
            </span>
          </span>
        }
      />
      <FileTree.Folder name="static/[[...vovk]]" defaultOpen>
        <FileTree.File
          name={
            <span>
              route.ts{' '}
              <span className="text-gray-500">
                (static segment <code>/api/customer/static</code> for OpenAPI)
              </span>
            </span>
          }
        />
      </FileTree.Folder>
    </FileTree.Folder>
  </FileTree.Folder>
</FileTree>

The resulting schema files will be located in the `.vovk-schema/` directory as follows:

<FileTree>
  <FileTree.Folder name=".vovk-schema" defaultOpen>
    <FileTree.File name="root.json" />
    <FileTree.File name="admin.json" />
    <FileTree.File name="customer.json" />
    <FileTree.Folder name="customer" defaultOpen>
      <FileTree.File name="static.json" />
    </FileTree.Folder>
    <FileTree.File name="_meta.json" />
  </FileTree.Folder>
</FileTree>

As you can see, the emitted files follow the recursive structure of the segments, so a segment `foo/bar/baz` will emit a schema file located at `.vovk-schema/foo/bar/baz.json`. The root segment, as the only exception to this rule, is represented by the `root.json` file for better organization.

The `_meta.json` file contains additional metadata, such as explicitly emitted fields from the [vovk.config](/config) file behind the `config` key, as well as other information.

When the Vovk CLI reads these files, it builds a single object with keys `segments` and `meta`, where `segments` has a flat structure with segment names as keys and their schemas as values, and `meta` contains the content of the `_meta.json` file. This object is then used to generate client-side RPC modules and OpenAPI documentation, but is also available on both the client side and server side as the `schema` export.

```ts
{
  "segments": {
    "": { ... }, // root segment schema from root.json
    "admin": { ... }, // admin segment schema from admin.json
    "customer": { ... }, // customer segment schema from customer.json
    "customer/static": { ... } // static segment schema from customer/static.json
  },
  "meta": { ... } // content of _meta.json file
}
```

```ts
import { schema } from 'vovk-client';
// or
import { schema } from 'vovk-client/schema'; // exports only the schema object, not the client-side RPC modules

import type { VovkSchema, VovkSegmentSchema } from 'vovk';

console.log(schema satisfies VovkSchema); // full schema
console.log(schema.segments.admin satisfies VovkSegmentSchema); // schema for the admin segment
```

The `schema` is also available in the [segmented client](/composed-and-segmented), containing a schema with a single segment.

```ts
{
  "segments": {
    "": { ... } // root segment schema from root.json
  },
  "meta": { ... } // content of _meta.json file
}
```

```ts
import { schema } from '@client/root';
// or
import { schema } from '@client/root/schema';
```

---

Example of a segment schema file:

```json filename=".vovk-schema/segments/foo.json"
{
  // Segment schema version
  "$schema": "https://vovk.dev/api/spec/v3/segment.json",
  // initSegment function option that defines whether the schema will be emitted for this segment
  "emitSchema": true,
  // Segment name; for the root segment, it's an empty string
  "segmentName": "foo",
  // List of controllers as key-value pairs for fast access
  // Key is the name of the variable that will be exported from "vovk-client"
  // Value is controller information
  "controllers": {
    "HelloRPC": {
      // RPC name that will be used in the client
      "rpcModuleName": "HelloRPC",
      // Original name of the controller class, used to determine the segment name when the controller is changed on "vovk dev"
      "originalControllerName": "HelloController",
      // An argument of the @prefix class decorator
      "prefix": "hello",
      // List of handlers as key-value pairs for fast access
      // Key is the static method name
      // Value is handler information
      "handlers": {
        "getHello": {
          // Endpoint that's concatenated with the prefix
          "path": "greeting",
          // HTTP method
          "httpMethod": "POST",
          // Validation for "body", "query", "params", "output", and "iteration"
          // Can contain any custom data; in this case, it's JSON schema emitted by "vovk-zod"
          "validation": {
            "body": {
              "type": "object",
              "properties": {
                "foo": {
                  "type": "string"
                }
              },
              "required": ["foo"],
              "additionalProperties": false,
              "x-isForm": true, // A Vovk-specific field that indicates the body is FormData
              "$schema": "https://json-schema.org/draft/2020-12/schema"
            },
            "query": {
              "type": "object",
              "properties": {
                "bar": {
                  "type": "string"
                }
              },
              "required": ["bar"],
              "additionalProperties": false,
              "$schema": "https://json-schema.org/draft/2020-12/schema"
            },
            "params": {
              "type": "object",
              "properties": {
                "baz": {
                  "type": "string"
                }
              },
              "required": ["baz"],
              "additionalProperties": false,
              "$schema": "https://json-schema.org/draft/2020-12/schema"
            },
            "output": {
              // or "iteration" for JSON Lines response
              "type": "object",
              "properties": {
                "hello": {
                  "type": "string"
                }
              },
              "required": ["hello"],
              "additionalProperties": false,
              "$schema": "https://json-schema.org/draft/2020-12/schema"
            }
          },
          // OpenAPI object that can be used to generate OpenAPI documentation, LLM tools, MCP, etc.
          "operationObject": {
            "summary": "Hello world",
            "description": "Hello world",
            "x-tool-description": "Hello world" // custom description for an LLM tool
          },
          // Custom data that can be defined by a custom decorator
          "misc": {
            "hello": "World"
          }
        }
      }
    }
  }
}
```
