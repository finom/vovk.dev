import { Steps, Tabs, Callout } from 'nextra/components'
import BasicController from '../../downloaded-examples/basic/BasicController.mdx';
import BasicExample from '../../downloaded-examples/basic/BasicExample.mdx';
import LiveBasicExample from '../../live-examples/LiveBasicExample';

# Manual install

<Steps>

## Create Next.js project with App Router and TypeScript

Follow [this instruction](https://nextjs.org/docs/getting-started/installation) to install Next.js. Use TypeScript, App Router and `src/` directory.

```bash
npx create-next-app my-app --ts --app
```

```bash
cd my-app
```

## Install "vovk" and "vovk-client"

The simplest way to init Vovk.ts and avoid some of the steps below is to run `npx vovk-cli init` or the shortcut `npx vovk-init` at the root of the Next.js project. This command asks a few questions and creates the [config](/config) file automatically.

```bash
npx vovk-init
```

---------

At the newly created folder run:

<Tabs items={['npm', 'pnpm', 'yarn']}>
  <Tabs.Tab>
  ```
  npm i vovk vovk-client
  ```
</Tabs.Tab>
  <Tabs.Tab>
  ```
  pnpm i vovk vovk-client
  ```
  </Tabs.Tab>
  <Tabs.Tab>
  ```
  yarn add vovk vovk-client
  ```
  </Tabs.Tab>
</Tabs>

## Create an empty config file

Create **vovk.config.ts** at the root of the project with the following content:

```ts filename="vovk.config.mjs"
// @ts-check
/** @type {import('vovk-cli').VovkConfig} */
const vovkConfig = {};

export default vovkConfig;

```

## Install validation library and enable client validation

Install one of the validation libraries with some additional packages.

- [vovk-yup](/validation/vovk-yup)
- [vovk-zod](/validation/vovk-zod)
- [vovk-dto](/validation/vovk-dto)

Set `validationLibrary` value at the config file to the name of the library you've installed.

If you want to enable client validation by default, you can set `validateOnClient` option at the config file. Also it's recommended 

```ts filename="vovk.config.mjs"
export default {
    // ...
    validationLibrary: 'vovk-zod',
    validateOnClient: 'vovk-zod/validateOnClient',
};
```

## Update "dev" NPM script

There are two ways to run Vovk.ts and Next.js server concurrently: explicitly and implicitly. The explicit way is to install `concurrently` package and run both scripts with it, this requires `PORT` variable to be set. The implicit way is to make Vovk.ts to run Next.js server by itself. At this case **vovk-cli** will assign the port automatically.

<Tabs items={['Explicit', 'Implicit']}>
  Install concurrently:
  <Tabs.Tab>
    <Tabs items={['npm', 'pnpm', 'yarn']} className="px-8 [&_+_div]:px-8">
      <Tabs.Tab>
      ```
      npm i -D concurrently
      ```
      </Tabs.Tab>
      <Tabs.Tab>
      ```
      pnpm i -D concurrently 
      ```
      </Tabs.Tab>
      <Tabs.Tab>
      ```
      yarn add -D concurrently
      ```
      </Tabs.Tab>
    </Tabs>

    Update the "dev" script in **package.json**:

    ```json
    "scripts": {
        "dev": "PORT=3000 concurrently 'vovk dev' 'next dev' --kill-others"
    }
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    Update the "dev" script in **package.json**:

    ```json
    "scripts": {
        "dev": "npx vovk dev --next-dev"
    }
    ```
  </Tabs.Tab>
</Tabs>

## Enable decorators

In your **tsconfig.json** set `"experimentalDecorators"` to `true`.

```json
{
    "compilerOptions": {
        "experimentalDecorators": true,
        // ...
    }
}
```

## Create controller

Create **HelloController.ts** at **/src/modules/hello/** with same-named static class. 

```ts filename="/src/modules/hello/HelloController.ts"
import { get, prefix } from "vovk";

@prefix('greetings') // prefix is optional
export default class HelloController {
    @get('greeting')
    static getHello() {
        return { greeting: 'Hello, World!' };
    }
}
```

## Create root segment

Create **/src/app/api/[[...vovk]]/route.ts** where **[[...vovk]]** is a folder name indicating what Next.js documentation calls ["Optional Catch-all Segment"](https://nextjs.org/docs/pages/building-your-application/routing/dynamic-routes#optional-catch-all-segments) that can be customized. This is the root entry point for API routes.

At the code below `HelloRPC` indicates the name of the exported client library and `HelloController` is the controller class created above.

```ts filename="/src/app/api/[[...vovk]]/route.ts"
import { initVovk } from 'vovk';
import HelloController from '../modules/hello/HelloController';

export const runtime = 'edge'; // this setting is optional

const controllers = { HelloRPC: HelloController };

// export types used by the client
export type Controllers = typeof controllers;

export const { GET, POST, PUT, DELETE } = initVovk({ controllers });
```

## Run "vovk dev"

Run `npm run dev` to start Vovk.ts and Next.js concurrently.

```sh
npm run dev
```

Navigate to [http://localhost:3000/api/greetings/greeting](http://localhost:3000/api/greetings/greeting) to see the result.

## Create a React component

Now the client is generated you can safely import your client library from **vovk-client**.

```tsx filename="/src/app/page.tsx"
'use client';
import { useState } from 'react';
import { HelloRPC } from 'vovk-client';
import type { VovkReturnType } from 'vovk';

export default function MyComponent() {
  const [serverResponse, setServerResponse] = useState<VovkReturnType<typeof HelloController.getHello>>();

  return (
    <>
      <button
        onClick={async () => {
          const response = await HelloController.getHello();
          setServerResponse(response);
        }}
      >
        Get Greeting from Server
      </button>
      <div>{serverResponse?.greeting}</div>
    </>
  );
}
```

Open [http://localhost:3000](http://localhost:3000) and see the result.

<Callout type="info" emoji="ℹ️">
Note that if you're using VSCode you're probably going to need to [restart TS server](https://stackoverflow.com/questions/64454845/where-is-vscodes-restart-ts-server) each time when you add a new controller or WPC class to your app
</Callout>

Next.js Server Components are also supported but require to define absolute URL (by default all requests are made to `/api`). Check the [Server Component Example](https://vovk-examples.vercel.app/server-component) for more information.



## Deploy

In order to build the client (not the schema) at **node_modules** you need to run the following command after dependency installation and before building the app.

```bash
npx vovk generate
```
</Steps>
